<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clicker</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&family=Share+Tech+Mono&family=Kalam:wght@700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <style>
        :root{--bg:#050508;--panel:#111115;--primary:#00f7ff;--secondary:#ff00e6;--danger:#ff3333;--success:#33ff33;--daily:#ffd700;--logic:#3b82f6;--prestige:#a600ff;--chaos:#ff5500;--font-mono:'Share Tech Mono',monospace;--font-head:'Orbitron',sans-serif;}
        body{margin:0;background:var(--bg);color:#eee;font-family:var(--font-mono);height:100vh;overflow:hidden;display:grid;grid-template-rows:auto 1fr;user-select:none;}
        
        #binary-vis{height:16px;background:#000;border-bottom:1px solid #333;display:flex;gap:2px;justify-content:center;overflow:hidden;padding:2px;}
        .bit{width:8px;background:#1a1a1a;transition:0.1s;} .bit.on{background:var(--primary);box-shadow:0 0 5px var(--primary);}

        #main-layout{display:grid;grid-template-columns:250px 1fr 250px 350px;height:100%;}
        
        /* 1. CLASSEMENT */
        #leaderboard-panel{background:#08080a;border-right:1px solid #333;padding:15px;display:flex;flex-direction:column;}
        .lb-header{border-bottom:1px solid #333;padding-bottom:10px;margin-bottom:10px;}
        .lb-title{color:var(--primary);font-size:1.1rem;margin-bottom:5px;display:block;}
        .lb-count{color:#888;font-size:0.7rem;display:block;}
        .lb-row{display:grid;grid-template-columns:30px 1fr auto;gap:10px;font-size:0.85rem;padding:8px 5px;border-bottom:1px solid #222;align-items:center;}
        .lb-row.me{color:var(--secondary);background:rgba(255,0,230,0.05);font-weight:bold;}
        .lb-rank{color:#666;} .lb-val{color:#fff;}

        /* 2. JEU */
        #game-stage{position:relative;display:flex;flex-direction:column;align-items:center;justify-content:center;background:radial-gradient(circle,#101015 0%,#000 100%);border-right:1px solid #333;}
        .heat-container{position:absolute;top:10px;width:70%;} .heat-top{display:flex;justify-content:space-between;font-size:0.7rem;color:#888;}
        .heat-bg{width:100%;height:8px;background:#222;border-radius:4px;overflow:hidden;margin-top:5px;} #heat-fill{height:100%;width:0%;background:linear-gradient(90deg,#0f0,#f00);}
        #total-score{font-family:var(--font-head);font-size:3.5rem;color:#fff;text-shadow:0 0 30px var(--primary);margin:10px 0;}
        #tier-display{color:var(--prestige);letter-spacing:2px;font-size:0.9rem;}
        #global-cps{color:#666;font-size:0.8rem;margin-bottom:10px;}

        /* CUBE & FX */
        .scene{width:220px;height:220px;margin:20px;perspective:1000px;cursor:pointer; position:relative;} 
        .cube{width:100%;height:100%;position:relative;transform-style:preserve-3d;animation:spin 20s linear infinite; will-change: transform;}
        .face{position:absolute;width:220px;height:220px;border:2px solid var(--primary);background:rgba(0,247,255,0.05);display:flex;align-items:center;justify-content:center;transition:0.3s;}
        
        /* --- NOUVEAUX EFFETS GLITCH --- */
        /* Bandes horizontales */
        #glitch-overlay {
            position: absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:10;
            background: repeating-linear-gradient(0deg, rgba(0,0,0,0) 0px, rgba(0,0,0,0) 4px, rgba(255,255,255,0.1) 5px, rgba(0,0,0,0) 6px);
            opacity: 0; mix-blend-mode: overlay;
        }
        /* Tremblement et Chromatic Aberration */
        .glitch-active .cube-outer {
            animation: spin 20s linear infinite, shake 0.2s cubic-bezier(.36,.07,.19,.97) infinite !important;
        }
        .glitch-active .face {
            box-shadow: -2px 0 var(--danger), 2px 0 var(--primary) !important;
        }
        @keyframes shake {
            10%, 90% { transform: translateZ(-110px) translate3d(-1px, 0, 0); }
            20%, 80% { transform: translateZ(-110px) translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translateZ(-110px) translate3d(-2px, 0, 0); }
            40%, 60% { transform: translateZ(-110px) translate3d(2px, 0, 0); }
        }

        /* SKINS */
        .cube.skin-matrix .face{border-color:#0f0!important;background:rgba(0,255,0,0.1)!important;box-shadow:0 0 20px #0f0!important;}
        .cube.skin-neon .face{border-color:#f0f!important;background:rgba(255,0,255,0.15)!important;box-shadow:inset 0 0 20px #0ff!important;}
        .cube.skin-gold .face{border-color:#ffd700!important;background:rgba(255,215,0,0.15)!important;box-shadow:0 0 30px #ffd700!important;}

        .cube-inner{position:absolute;top:60px;left:60px;width:100px;height:100px;transform-style:preserve-3d;animation:spinRev 10s linear infinite;display:none;}
        .cube-inner .face{width:100px;height:100px;border-color:var(--prestige);background:rgba(166,0,255,0.2);}
        .cube-core{position:absolute;top:90px;left:90px;width:40px;height:40px;transform-style:preserve-3d;animation:spin 5s linear infinite;display:none;}
        .cube-core .face{width:40px;height:40px;border-color:#fff;background:#fff;}

        .f-f{transform:translateZ(110px);} .f-b{transform:rotateY(180deg) translateZ(110px);} .f-l{transform:rotateY(-90deg) translateZ(110px);} .f-r{transform:rotateY(90deg) translateZ(110px);} .f-t{transform:rotateX(90deg) translateZ(110px);} .f-bt{transform:rotateX(-90deg) translateZ(110px);}
        .i-f{transform:translateZ(50px);} .i-b{transform:rotateY(180deg) translateZ(50px);} .i-l{transform:rotateY(-90deg) translateZ(50px);} .i-r{transform:rotateY(90deg) translateZ(50px);} .i-t{transform:rotateX(90deg) translateZ(50px);} .i-bt{transform:rotateX(-90deg) translateZ(50px);}
        @keyframes spin{0%{transform:rotateX(0) rotateY(0);}100%{transform:rotateX(360deg) rotateY(360deg);}} @keyframes spinRev{0%{transform:rotateX(0) rotateY(0);}100%{transform:rotateX(-360deg) rotateY(-360deg);}}

        .hud-grid{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;} .hud-item{background:#1a1a20;border:1px solid #333;padding:5px;min-width:70px;text-align:center;border-radius:4px;} .active-buff{border-color:var(--success);color:var(--success);}

        /* 3. COMMU */
        #comm-panel{padding:15px;background:#0c0c10;border-right:1px solid #333;display:flex;flex-direction:column;}
        .post-it{background:#f7e98e;color:#000;padding:10px;width:100%;flex:1;min-height:200px;box-shadow:2px 2px 10px #000;font-family:'Kalam',cursive;margin-bottom:20px;display:flex;flex-direction:column;box-sizing:border-box;transform:rotate(-1deg);}
        #comm-note{flex:1;background:transparent;border:none;resize:none;font-family:inherit;font-size:1rem;color:#222;}
        .my-stats{border-top:1px solid #333;padding-top:15px;text-align:center;}

        /* 4. SIDEBAR */
        #sidebar{background:var(--panel);overflow-y:auto;padding:15px;display:flex;flex-direction:column;gap:12px;}
        .panel{border:1px solid #333;background:rgba(255,255,255,0.02);padding:10px;border-radius:4px;}
        h2{margin:0 0 5px 0;font-size:0.75rem;border-bottom:1px solid #444;padding-bottom:4px;color:var(--primary);}
        button{width:100%;padding:8px;cursor:pointer;background:#222;border:1px solid #555;color:#eee;font-weight:bold;margin-top:5px;display:flex;justify-content:space-between;font-size:0.7rem;} button:disabled{opacity:0.5;filter:grayscale(1);} button:hover:not(:disabled){filter:brightness(1.2);}
        .btn-daily{background:var(--daily);color:#000;} .btn-maint{background:var(--danger);color:#000;} .btn-logic{background:var(--logic);color:#fff;} .btn-farm{background:var(--secondary);color:#fff;} .btn-prestige{background:var(--prestige);color:#fff;justify-content:center;}
        .shop-row{display:flex;justify-content:space-between;padding:5px;border-bottom:1px solid #222;cursor:pointer;font-size:0.8rem;} .shop-row:hover{background:#222;}

        /* MODALS */
        .modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);z-index:200;display:flex;align-items:center;justify-content:center;} .modal-box{background:#111;border:2px solid var(--primary);padding:20px;width:90%;max-width:600px;text-align:center;}
        
        .logic-container { display: flex; flex-direction: column; align-items: center; gap: 10px; margin: 20px 0; }
        .logic-row { display: flex; gap: 20px; justify-content: center; }
        .logic-wire-v { width: 2px; height: 20px; background: #555; margin: 0 auto; }
        .logic-switch { width: 35px; height: 35px; border: 2px solid #555; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #fff; font-weight: bold; }
        .logic-switch.on { background: var(--logic); border-color: #fff; box-shadow: 0 0 10px var(--logic); }
        .logic-gate { border: 1px solid #777; background: #222; padding: 5px 10px; font-size: 0.7rem; color: #aaa; min-width: 40px; }
        
        .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;width:200px;margin:20px auto;} .grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:5px;width:220px;margin:20px auto;}
        .cell{height:50px;background:#222;border:1px solid #444;cursor:pointer;} .cell.lit{background:var(--secondary);box-shadow:0 0 20px var(--secondary);border-color:#fff;} .cell.on{background:var(--success);box-shadow:0 0 10px var(--success);}
        .g-cell{height:40px;background:#222;border:1px solid #444;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:1.2rem;} .g-cell:hover { background: #333; }

        @media(max-width:1100px){body{grid-template-rows:auto auto;} #main-layout{grid-template-columns:1fr;} #leaderboard-panel{display:none;} #game-stage{height:50vh;}}
    </style>
</head>
<body>

    <div id="top-bar"><div id="binary-vis"></div></div>

    <div id="main-layout">
        <div id="leaderboard-panel">
            <div class="lb-header">
                <span class="lb-title">CLASSEMENT</span>
                <span class="lb-count"><span id="online-count">0</span> EN LIGNE</span>
            </div>
            <div id="lb-list">Chargement...</div>
        </div>

        <div id="game-stage">
            <div class="heat-container">
                <div class="heat-top"><span>STABILITÉ (12H)</span><button onclick="window.coolSystem()" style="width:auto;padding:2px 8px;margin:0;">REFROIDIR</button></div>
                <div class="heat-bg"><div id="heat-fill"></div></div>
                <div id="overheat-msg" style="color:var(--danger);display:none;font-weight:bold;text-align:center;">⚠️ SURCHAUFFE ⚠️</div>
            </div>

            <div id="tier-display">TIER 0</div>
            <div id="total-score">0</div>
            <div id="global-cps">GLOBAL: 0/s</div>

            <div class="scene" id="click-zone">
                <div id="glitch-overlay"></div> <div class="cube cube-outer" id="the-cube">
                    <div class="face f-f"></div><div class="face f-b"></div><div class="face f-l"></div>
                    <div class="face f-r"></div><div class="face f-t"></div><div class="face f-bt"></div>
                </div>
                <div class="cube-inner" id="cube-inner">
                    <div class="face i-f"></div><div class="face i-b"></div><div class="face i-l"></div>
                    <div class="face i-r"></div><div class="face i-t"></div><div class="face i-bt"></div>
                </div>
                <div class="cube-core" id="cube-core">
                    <div class="face f-f"></div><div class="face f-b"></div><div class="face f-l"></div>
                    <div class="face f-r"></div><div class="face f-t"></div><div class="face f-bt"></div>
                </div>
            </div>

            <div class="hud-grid">
                <div class="hud-item" id="h-maint"><div class="hud-val">x1.0</div><div class="hud-lbl">MAINT</div></div>
                <div class="hud-item" id="h-daily"><div class="hud-val">x1.5</div><div class="hud-lbl">DAILY</div></div>
                <div class="hud-item" id="h-logic"><div class="hud-val">x1.2</div><div class="hud-lbl">LOGIC</div></div>
                <div class="hud-item" id="h-chaos"><div class="hud-val">x1.7</div><div class="hud-lbl">QUANTUM</div></div>
            </div>

            <button onclick="window.startQuantum()" style="width:200px;margin-top:20px;background:var(--chaos);justify-content:center;">STABILISATEUR QUANTIQUE</button>
            <div id="quantum-bar" style="width:200px;height:30px;background:#222;border:1px solid #555;position:relative;margin:10px auto;display:none;cursor:pointer;"><div id="q-target" style="position:absolute;width:40px;height:100%;background:rgba(0,255,0,0.3);left:50%;border-left:1px solid #0f0;border-right:1px solid #0f0;"></div><div id="q-cursor" style="position:absolute;width:4px;height:100%;background:#fff;left:0;"></div></div>
        </div>

        <div id="comm-panel">
            <div class="post-it">
                <div style="font-weight:bold;border-bottom:1px dashed #000;margin-bottom:5px;padding-bottom:2px;">NOTE DU RÉSEAU</div>
                <textarea id="comm-note" maxlength="500"></textarea>
            </div>
            <div class="my-stats">
                <div style="font-size:0.8rem;color:#888;">PRODUCTION PERSO</div>
                <div class="flux-val" id="local-cps" style="font-size:2rem;font-weight:bold;color:var(--secondary);">0</div>
                <div style="font-size:0.7rem;">/ sec</div>
                <div style="margin-top:10px;font-weight:bold;">MN: <span id="mn-val" style="color:var(--primary);">0</span></div>
            </div>
        </div>

        <div id="sidebar">
            <div class="panel">
                <h2>PROTOCOLES GLOBAUX</h2>
                <button onclick="window.startDaily()" id="btn-daily"><span>DAILY (x1.5)</span><span id="t-daily">...</span></button>
                <button onclick="window.startMaint()" id="btn-maint"><span>MAINT (x2)</span><span id="t-maint">...</span></button>
                <button onclick="window.startLogic()" id="btn-logic"><span>PORTES (x1.2)</span><span id="t-logic">...</span></button>
            </div>
            <div class="panel">
                <h2>FARMING</h2>
                <button onclick="window.startFlux()" class="btn-farm"><span>FLUX (SIMON)</span><span>+1/s</span></button>
                <button onclick="window.startGlyph()" class="btn-farm"><span>GLYPH BREACH</span><span>MN++</span></button>
                <button onclick="window.startHack()" class="btn-farm"><span>LIGHTS OUT</span><span>MN++</span></button>
            </div>
            <div class="panel">
                <h2>BOUTIQUE (MN)</h2>
                <div class="shop-row" onclick="window.buy('bot')"><span>Sonde (1/s)</span><span id="c-bot" style="color:var(--primary)">50</span></div>
                <div class="shop-row" onclick="window.buy('net')"><span>Réseau (10/s)</span><span id="c-net" style="color:var(--primary)">500</span></div>
                <div style="border-top:1px solid #333;margin-top:5px;padding-top:5px;">
                    <div style="font-size:0.6rem;color:#aaa">DISTORSION (1H)</div>
                    <button onclick="window.buy('warp')" id="btn-warp" style="justify-content:center;background:linear-gradient(45deg,#004,#008);">ACTIVER (<span id="c-warp">5k</span>)</button>
                </div>
            </div>
            <div class="panel">
                <h2 style="color:var(--prestige)">SINGULARITÉ</h2>
                <button onclick="window.doPrestige()" style="background:var(--prestige);justify-content:center;">PRESTIGE (Tier UP)</button>
            </div>
            <div class="panel">
                <h2>SKINS</h2>
                <div class="shop-row" onclick="window.buySkin('skin-matrix', 10000)"><span style="color:#0f0">Matrix</span><span>10k</span></div>
                <div class="shop-row" onclick="window.buySkin('skin-neon', 50000)"><span style="color:#f0f">Neon</span><span>50k</span></div>
                <div class="shop-row" onclick="window.buySkin('skin-gold', 100000)"><span style="color:#ffd700">Gold</span><span>100k</span></div>
            </div>
        </div>
    </div>

    <div class="modal" id="modal-login" style="display:flex;">
        <div class="modal-box">
            <h1 style="color:var(--primary)">Speudo</h1>
            <input type="text" id="username" placeholder="Votre Pseudo..." maxlength="12" style="background:#333;color:#fff;border:1px solid #555;padding:10px;text-align:center;width:80%;">
            <button onclick="window.performLogin()" style="background:var(--primary);color:#000;margin-top:20px;justify-content:center;">ENTRER</button>
        </div>
    </div>

    <div class="modal" id="modal-simon" style="display:none"><div class="modal-box"><h2 style="color:var(--secondary)">MÉMOIRE</h2><div class="grid-3" id="simon-grid"></div><div id="simon-msg">...</div></div></div>
    
    <div class="modal" id="modal-glyph" style="display:none">
        <div class="modal-box">
            <h2>BREACH</h2>
            <div id="glyph-tgt" style="font-size:2rem;color:var(--success);margin:10px;">...</div>
            <div class="grid-4" id="glyph-grid"></div>
        </div>
    </div>

    <div class="modal" id="modal-hack" style="display:none"><div class="modal-box"><h2>ÉTEIGNEZ TOUT</h2><div class="grid-3" id="hack-grid"></div><button onclick="document.getElementById('modal-hack').style.display='none'">FERMER</button></div></div>
    <div class="modal" id="modal-daily" style="display:none"><div class="modal-box"><h2 style="color:var(--daily)">ALIGNEMENT</h2><div style="background:#333;height:40px;position:relative;margin:20px 0;overflow:hidden;"><div style="position:absolute;left:45%;width:10%;height:100%;border:1px solid #0f0;background:rgba(0,255,0,0.2)"></div><div id="daily-cur" style="position:absolute;left:0;width:6px;height:100%;background:#fff;"></div></div><button onclick="window.stopDaily()" style="background:#fff;color:#000">STOP</button></div></div>

    <div class="modal" id="modal-logic" style="display:none">
        <div class="modal-box">
            <h2 style="color:var(--logic)">CIRCUIT LOGIQUE</h2>
            <p style="font-size:0.8rem">4 Entrées &rarr; 2 Portes &rarr; Finale</p>
            <div class="logic-container" id="circuit-board"></div>
            <button onclick="document.getElementById('modal-logic').style.display='none'">FERMER</button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
        apiKey: "AIzaSyB0lwTP0tdgFtmliFk5RLPJyHxXaNvXbxA",
        authDomain: "lechatderemi.firebaseapp.com",
        databaseURL: "https://lechatderemi-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "lechatderemi",
        storageBucket: "lechatderemi.firebasestorage.app",
        messagingSenderId: "703344968670",
        appId: "1:703344968670:web:cc6c409376db0298df134f"
        };

        let db;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();
        } catch(e) { alert("Erreur Firebase: " + e.message); }

        const ROOT = 'ipsa_v23';

        let p = { name:"", mn:0, bots:0, nets:0, fluxSess:0, skin:'', quantumEnd:0 };
        const saved = localStorage.getItem(ROOT);
        if(saved) { const l=JSON.parse(saved); p={...p, ...l, fluxSess:0, quantumEnd:0}; }
        
        let G = { score:0, tier:0, heatStart:Date.now(), buffs:{daily:0,maint:0,logic:0} };

        // LOGIN
        window.performLogin = function() {
            const val = document.getElementById('username').value.trim().substring(0,12);
            if(val) {
                p.name = val;
                localStorage.setItem(ROOT, JSON.stringify(p));
                document.getElementById('modal-login').style.display='none';
                initUser();
            } else alert("Pseudo ?");
        };
        
        if(p.name) {
            document.getElementById('modal-login').style.display='none';
            if(db) initUser();
        }

        function initUser() {
            if(p.skin) setTimeout(()=>applySkin(p.skin), 200);
            db.ref(".info/connected").on("value", s=>{
                if(s.val()) {
                    const c = db.ref(`${ROOT}/pres/${p.name}`);
                    c.onDisconnect().remove();
                    c.set(true);
                }
            });
            db.ref(`${ROOT}/users/${p.name}`).transaction(u => u || {score:0});
        }

        // LISTENERS
        if(db) {
            db.ref(`${ROOT}/game/score`).on('value', s=>G.score=s.val()||0);
            db.ref(`${ROOT}/game/tier`).on('value', s=>{G.tier=s.val()||0; updateVisuals();});
            db.ref(`${ROOT}/game/heatStart`).on('value', s=>G.heatStart=s.val()||Date.now());
            db.ref(`${ROOT}/game/buffs`).on('value', s=>G.buffs=s.val()||{});
            db.ref(`${ROOT}/pres`).on('value', s=>document.getElementById('online-count').innerText = s.numChildren());
            db.ref(`${ROOT}/note`).on('value', s=>{
                if(document.activeElement.id!=='comm-note') document.getElementById('comm-note').value = s.val()||"";
            });

            db.ref(`${ROOT}/users`).on('value', s=>{
                const arr=[]; s.forEach(c=>arr.push({n:c.key, s:c.val().score||0}));
                arr.sort((a,b)=>b.s-a.s);
                const d=document.getElementById('lb-list'); d.innerHTML='';
                arr.slice(0,10).forEach((u,i)=>{
                    d.innerHTML += `
                    <div class="lb-row ${u.n===p.name?'me':''}">
                        <span class="lb-rank">#${i+1}</span>
                        <span>${u.n}</span>
                        <span class="lb-val">${fmt(u.s)}</span>
                    </div>`;
                });
            });
        }
        document.getElementById('comm-note').addEventListener('change', e=>db.ref(`${ROOT}/note`).set(e.target.value));

        // LOOP
        const binVis = document.getElementById('binary-vis');
        for(let i=0;i<40;i++){let b=document.createElement('div'); b.className='bit'; binVis.appendChild(b);}
        
        let lastTime=Date.now(), lastGlobal=0, cpsBuff=0;

        setInterval(()=>{
            if(!db) return;
            const now = Date.now();
            
            const bD = G.buffs.daily>now ? 1.5 : 1.0;
            const bM = G.buffs.maint>now ? 2.0 : 1.0;
            const bL = G.buffs.logic>now ? 1.2 : 1.0;
            const bQ = p.quantumEnd>now ? 1.7 : 1.0;
            const bT = Math.pow(5, G.tier);

            const hrs = (now-G.heatStart)/3600000;
            const pct = Math.min(100, (hrs/12)*100);
            document.getElementById('heat-fill').style.width = pct+"%";
            const penalty = pct>=100 ? 0.5 : 1.0;
            document.getElementById('overheat-msg').style.display = pct>=100?'block':'none';

            updateHud('h-daily', bD>1); updateHud('h-maint', bM>1);
            updateHud('h-logic', bL>1); updateHud('h-chaos', bQ>1);
            
            updateBtn('btn-daily', 't-daily', G.buffs.daily);
            updateBtn('btn-maint', 't-maint', G.buffs.maint);
            updateBtn('btn-logic', 't-logic', G.buffs.logic);

            document.getElementById('total-score').innerText = fmt(G.score);
            document.getElementById('tier-display').innerText = `TIER ${G.tier} (x${fmt(bT)})`;
            document.getElementById('mn-val').innerText = fmt(p.mn);

            // Binary Vis
            if(Math.random()>0.8) {
                const bin=Math.floor(G.score).toString(2).split('').reverse();
                Array.from(binVis.children).forEach((b,i)=>{
                    if(i<bin.length && bin[i]==='1') b.classList.add('on'); else b.classList.remove('on');
                });
            }

            // --- FX HEARTBEAT & GLITCH ---
            if(G.score > 0) {
                // Pulse
                let intensity = Math.min(0.2, Math.log10(G.score + 1) / 50); 
                let beat = 1 + Math.sin(Date.now() / 200) * intensity;
                // Preserve rotateZ from glitch if needed, but here simple scale
                document.getElementById('click-zone').style.transform = `scale(${beat})`;

                // Glitch Threshold (Starts visible at 1k, strong at 1M)
                let glitchDiv = document.getElementById('glitch-overlay');
                let cube = document.getElementById('click-zone');
                
                if(G.score > 1000) {
                    let glitchIntensity = Math.min(1, Math.log10(G.score) / 9); // 0 to 1
                    glitchDiv.style.opacity = glitchIntensity * 0.5; // Max 0.5 opacity for bands
                    
                    if(Math.random() < (glitchIntensity * 0.1)) { // Random glitches
                        cube.classList.add('glitch-active');
                        setTimeout(() => cube.classList.remove('glitch-active'), 100);
                    }
                } else {
                    glitchDiv.style.opacity = 0;
                }
            }

            if(now-lastTime>2000) {
                const spd = Math.max(0, (G.score - lastGlobal)/2);
                document.getElementById('global-cps').innerText = `GLOBAL: ${fmt(spd)} / s`;
                lastGlobal = G.score; lastTime = now;
            }

            const prod = calcProd() * bD * bM * bL * bQ * bT * penalty;
            document.getElementById('local-cps').innerText = fmt(prod);
            updateShop(prod);

            if(prod>0) {
                cpsBuff += prod/30;
                if(cpsBuff>=1){ const s=Math.floor(cpsBuff); cpsBuff-=s; p.mn+=s; sendScore(s); }
            }
        }, 33);

        setInterval(()=>localStorage.setItem(ROOT, JSON.stringify(p)), 2000);

        function fmt(n) {
            if(n>=1e21) return "MAX"; if(n<1000) return Math.floor(n);
            const i=Math.floor(Math.log10(n)/3);
            return (n/Math.pow(1000,i)).toFixed(2) + ["","k","M","B","T","Qa"][i];
        }
        function calcProd() { return (p.bots*1)+(p.nets*10)+p.fluxSess; }
        function sendScore(amt) {
            db.ref(`${ROOT}/game/score`).transaction(s=>(s||0)+amt);
            if(p.name) db.ref(`${ROOT}/users/${p.name}/score`).transaction(s=>(s||0)+amt);
        }
        function updateHud(id,on){document.getElementById(id).className=on?'hud-item active-buff':'hud-item';}
        function updateBtn(bid,tid,end){
            const b=document.getElementById(bid), t=document.getElementById(tid);
            if(end>Date.now()){b.disabled=true; t.innerText=Math.ceil((end-Date.now())/60000)+"m";}
            else{b.disabled=false; t.innerText="PRET";}
        }
        function updateVisuals(){
            document.getElementById('cube-inner').style.display = G.tier>=1?'block':'none';
            document.getElementById('cube-core').style.display = G.tier>=2?'block':'none';
        }

        window.coolSystem = () => db.ref(`${ROOT}/game/heatStart`).set(Date.now());
        window.doPrestige = () => {
            const req = 1000000 * Math.pow(100, G.tier);
            if(G.score >= req) {
                if(confirm("RESET GLOBAL ?")) { db.ref(`${ROOT}/game/score`).set(0); db.ref(`${ROOT}/game/tier`).set(G.tier+1); }
            } else alert("Requis: "+fmt(req));
        };
        window.buy = (t) => {
            if(t==='bot'){const c=Math.floor(50*Math.pow(1.4,p.bots)); if(p.mn>=c){p.mn-=c; p.bots++;}}
            if(t==='net'){const c=Math.floor(500*Math.pow(1.4,p.nets)); if(p.mn>=c){p.mn-=c; p.nets++;}}
            if(t==='warp'){const c=5000; if(p.mn>=c){if(confirm("Warp?")){p.mn-=c; sendScore(calcProd()*3600);}}}
        };
        window.buySkin = (s,c) => { if(p.mn>=c){if(confirm("Skin?")){p.mn-=c; p.skin=s; applySkin(s);}}else alert("Pas assez"); };
        function applySkin(s){ const el=document.getElementById('the-cube'); if(el) el.className="cube cube-outer "+s; }
        function updateShop(prod) {
            document.getElementById('c-bot').innerText=fmt(Math.floor(50*Math.pow(1.4,p.bots)));
            document.getElementById('c-net').innerText=fmt(Math.floor(500*Math.pow(1.4,p.nets)));
            document.getElementById('c-warp').innerText=fmt(Math.max(5000, Math.floor(prod*3600)));
        }

        document.getElementById('click-zone').addEventListener('pointerdown', (e)=>{
            const bD=G.buffs.daily>Date.now()?1.5:1; const bM=G.buffs.maint>Date.now()?2:1;
            const bL=G.buffs.logic>Date.now()?1.2:1; const bQ=p.quantumEnd>Date.now()?1.7:1;
            const bT=Math.pow(5, G.tier);
            const hrs=(Date.now()-G.heatStart)/3600000;
            let val=Math.max(1, Math.floor(1*bD*bM*bL*bQ*bT));
            if(hrs>=12) val=Math.floor(val/2);
            p.mn+=val; sendScore(val);
            const d=document.createElement('div'); d.innerText="+"+fmt(val);
            d.style.cssText=`position:fixed;left:${e.clientX}px;top:${e.clientY}px;color:#fff;font-weight:bold;animation: float 1s forwards; pointer-events:none;`;
            document.body.appendChild(d); setTimeout(()=>d.remove(),1000);
        });
        const st=document.createElement('style'); st.innerHTML="@keyframes float{to{transform:translateY(-50px);opacity:0}}"; document.head.appendChild(st);

        // --- QUANTUM (CORRIGÉ) ---
        let qAnim, qPos=0, qDir=1.5, qActive=false, qTarget=50;

        window.startQuantum = () => {
            if(p.quantumEnd > Date.now()) return;
            
            document.getElementById('quantum-bar').style.display='block';
            qActive = true; 
            qPos = 0;
            
            // 1. Définir une cible aléatoire (entre 20% et 80%)
            qTarget = 20 + Math.random() * 60;
            
            // 2. Mettre à jour le visuel
            const bar = document.getElementById('q-target');
            bar.style.left = qTarget + "%";
            // Important : on centre la barre sur son point exact
            bar.style.transform = "translateX(-50%)"; 
            
            loopQ();
        };

        function loopQ(){
            if(!qActive) return;
            qPos += qDir;
            // Rebondir sur les bords
            if(qPos > 100 || qPos < 0) qDir *= -1;
            document.getElementById('q-cursor').style.left = qPos + "%";
            qAnim = requestAnimationFrame(loopQ);
        }

        document.getElementById('quantum-bar').onclick = () => {
            qActive = false; 
            cancelAnimationFrame(qAnim); 
            document.getElementById('quantum-bar').style.display='none';
            
            // 3. Vérifier la distance entre le curseur et la cible (+/- 5%)
            if(Math.abs(qPos - qTarget) < 5) {
                p.quantumEnd = Date.now() + 60000; 
                alert("STABILISATION RÉUSSIE !"); 
            } else { 
                alert("ÉCHEC DE LA SYNCHRONISATION"); 
            }
        };

        // FLUX
        window.startFlux = () => { 
            document.getElementById('modal-simon').style.display = 'flex'; 
            playSimon(); 
        };

        function playSimon() {
            const g = document.getElementById('simon-grid'); 
            g.innerHTML = '';
            // Création de la grille
            for (let i = 0; i < 9; i++) {
                const d = document.createElement('div'); 
                d.className = 'cell'; 
                d.dataset.id = i; 
                g.appendChild(d);
            }

            // Séquence aléatoire
            const s = [0, 1, 2, 3, 4, 5, 6, 7, 8].sort(() => Math.random() - 0.5).slice(0, 3);
            let k = 0, canClick = false, idx = 0;

            // Animation de la séquence
            const int = setInterval(() => {
                if (k >= 3) {
                    clearInterval(int); 
                    document.getElementById('simon-msg').innerText = "GO"; 
                    canClick = true; 
                    return;
                }
                const c = g.children[s[k]]; 
                c.classList.add('lit'); 
                setTimeout(() => c.classList.remove('lit'), 300); 
                k++;
            }, 600);

            // Gestion des clics joueur
            Array.from(g.children).forEach(c => c.onclick = () => {
                if (!canClick) return;
                
                c.classList.add('lit'); 
                setTimeout(() => c.classList.remove('lit'), 100);

                if (parseInt(c.dataset.id) === s[idx]) {
                    idx++; 
                    if (idx >= 3) {
                        let bonus = 1 + Math.floor(p.mn / 100);
                        p.fluxSess += bonus;
                        
                        document.getElementById('modal-simon').style.display = 'none';
                        alert("Succès ! +" + bonus + "/s ajouté au flux.");
                    }
                } else {
                    document.getElementById('modal-simon').style.display = 'none'; 
                    alert("Raté !");
                }
            });
        }

        // DAILY
        let dAnim, dPos=0, dDir=1;
        window.startDaily=()=>{if(G.buffs.daily>Date.now())return; document.getElementById('modal-daily').style.display='flex'; loopD();};
        function loopD(){dPos+=1.2*dDir; if(dPos>100||dPos<0)dDir*=-1; document.getElementById('daily-cur').style.left=dPos+"%"; dAnim=requestAnimationFrame(loopD);}
        window.stopDaily=()=>{ cancelAnimationFrame(dAnim); document.getElementById('modal-daily').style.display='none'; if(dPos>=45&&dPos<=55) db.ref(`${ROOT}/game/buffs/daily`).set(Date.now()+3600000); else alert("RATE"); };

        // MAINT
        window.startMaint=()=>{if(G.buffs.maint>Date.now())return; const a=Math.floor(Math.random()*50), b=Math.floor(Math.random()*50); if(parseInt(prompt(`${a}+${b}?`))===a+b) db.ref(`${ROOT}/game/buffs/maint`).set(Date.now()+7200000);};

        // GLYPH (RESTORED VERSION)
        const chars = ['Ω','Σ','Π','Δ','Ψ','Φ','Γ','Λ','Ξ','Θ'];
        let gSeq = [], gIdx = 0;

        window.startGlyph = () => {
            document.getElementById('modal-glyph').style.display = 'flex';
            playGlyph();
        };

        function playGlyph() {
            const g = document.getElementById('glyph-grid');
            g.innerHTML = '';
            const targetDiv = document.getElementById('glyph-tgt');

            const board = [];
            for(let i=0; i<16; i++) {
                board.push(chars[Math.floor(Math.random() * chars.length)]);
            }

            board.forEach((char, index) => {
                const d = document.createElement('div');
                d.className = 'g-cell';
                d.innerText = char;
                d.onclick = () => checkGlyphClick(char, d);
                g.appendChild(d);
            });

            // Pick 3 from board
            gSeq = [
                board[Math.floor(Math.random()*16)],
                board[Math.floor(Math.random()*16)],
                board[Math.floor(Math.random()*16)]
            ];

            gIdx = 0;
            targetDiv.innerText = gSeq.join(' ');
        }

        function checkGlyphClick(char, div) {
            if(char === gSeq[gIdx]) {
                div.style.background = "#0f0";
                gIdx++;
                if(gIdx >= gSeq.length) {
                    setTimeout(() => {
                        document.getElementById('modal-glyph').style.display = 'none';
                        addmnglyph = Math.floor(calcProd() * 1200) + 1000;
                        p.mn += addmnglyph;
                        alert("BREACH REUSSI : MN++ " + addmnglyph);
                    }, 200);
                }
            } else {
                div.style.background = "#f00";
                setTimeout(()=>div.style.background="#222", 200);
            }
        }

        // HACK
        window.startHack=()=>{document.getElementById('modal-hack').style.display='flex'; initHack();};
        function initHack(){
            const g=document.getElementById('hack-grid'); g.innerHTML=''; let s=[0,0,0,0,0,0,0,0,0];
            const tog=(i)=>{s[i]=!s[i]; if(i%3>0)s[i-1]=!s[i-1]; if(i%3<2)s[i+1]=!s[i+1]; if(i>=3)s[i-3]=!s[i-3]; if(i<6)s[i+3]=!s[i+3]; ren(); if(s.every(x=>!x)){p.mn+=Math.floor(calcProd()*300)+100; alert("MN++"); document.getElementById('modal-hack').style.display='none';}};
            const ren=()=>{Array.from(g.children).forEach((c,i)=>c.className='cell '+(s[i]?'lit':''));};
            s.forEach((_,i)=>{const d=document.createElement('div'); d.className='cell'; d.onclick=()=>tog(i); g.appendChild(d);});
            for(let k=0;k<10;k++)tog(Math.floor(Math.random()*9));
        }

        // LOGIC
        window.startLogic=()=>{if(G.buffs.logic>Date.now())return; document.getElementById('modal-logic').style.display='flex'; initLogic();};
        function initLogic(){
            const b=document.getElementById('circuit-board'); b.innerHTML='';
            let inputs=[0,0,0,0]; const gT=[0,0,0].map(()=>Math.floor(Math.random()*3));
            function r(){
                b.innerHTML='';
                const r1=document.createElement('div'); r1.className='logic-row';
                inputs.forEach((v,i)=>{const s=document.createElement('div'); s.className='switch '+(v?'on':''); s.innerText=v; s.onclick=()=>{inputs[i]=1-inputs[i];r();}; r1.appendChild(s);});
                b.appendChild(r1);
                
                const w1=document.createElement('div'); w1.innerHTML='<div style="display:flex;gap:40px;"><div class="logic-wire-v"></div><div class="logic-wire-v"></div><div class="logic-wire-v"></div><div class="logic-wire-v"></div></div>'; b.appendChild(w1);

                const r2=document.createElement('div'); r2.className='logic-row';
                r2.innerHTML=`<div class="logic-gate">${gN(gT[0])}</div><div class="logic-gate">${gN(gT[1])}</div>`; b.appendChild(r2);

                const w2=document.createElement('div'); w2.innerHTML='<div style="display:flex;gap:70px;"><div class="logic-wire-v"></div><div class="logic-wire-v"></div></div>'; b.appendChild(w2);

                const r3=document.createElement('div'); r3.className='logic-row';
                r3.innerHTML=`<div class="logic-gate">${gN(gT[2])}</div>`; b.appendChild(r3);

                const resA=eV(gT[0],inputs[0],inputs[1]), resB=eV(gT[1],inputs[2],inputs[3]), fin=eV(gT[2],resA,resB);
                const bulb=document.createElement('div'); bulb.className='switch '+(fin?'on':''); bulb.style.borderRadius="50%"; b.appendChild(bulb);
                
                if(fin){db.ref(`${ROOT}/game/buffs/logic`).set(Date.now()+3600000); setTimeout(()=>{document.getElementById('modal-logic').style.display='none';},300);}
            } r();
        }
        function gN(t){return['AND','OR','XOR'][t]} function eV(t,a,b){if(t==0)return(a&&b)?1:0;if(t==1)return(a||b)?1:0;return(a!=b)?1:0;}

    </script>
</body>
</html>
